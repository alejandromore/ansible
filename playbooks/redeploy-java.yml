---
- name:  Redesplegar solo JAR (r谩pido)
  hosts: app
  become: true
  gather_facts: true
  
  vars:
    app_install_dir: "/opt/{{ app_name }}"
    jar_source_path: "{{ playbook_dir }}/../files/app/{{ app_jar_name }}"
    
  tasks: 
    - name: Detener aplicaci贸n
      systemd:
       name: "{{ app_name }}"
       state: stopped
    
    - name: Copiar nueva versi贸n
      copy:
        src: "{{ jar_source_path }}"
        dest: "{{ app_install_dir }}/"
        owner: "{{ app_name }}"
        group: "{{ app_name }}"
        mode: '0644'
        force: yes
      register: jar_updated
    
    - name: Iniciar aplicaci贸n
      systemd:
        name: "{{ app_name }}"
        enabled: yes
        state: started
        daemon_reload: yes
    
    - name: Verificar salud de la aplicaci贸n
      uri:
        url: "http://localhost:{{ app_port }}{{ app_endpoint }}"
        method: GET
        status_code: 200
        timeout: 10
      register: health_result
      retries: 3
      delay: 5
        
    - name: Mostrar resultado
      debug:
        msg: "Aplicaci贸n {{ app_name }} desplegada en puerto {{ app_port }}"
      when: health_result.status == 200
